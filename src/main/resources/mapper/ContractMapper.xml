<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yonyou.cons.dao.ConDao">

	<resultMap type="com.yonyou.cons.entity.Contract" id="Contract">
		<id column="conid" property="conid" jdbcType="VARCHAR" />
		<result column="conname" property="conname" jdbcType="VARCHAR" />
		<result column="company" property="company" jdbcType="VARCHAR" />
		<result column="starttime" property="startDate" jdbcType="VARCHAR" />
		<result column="endtime" property="endDate" jdbcType="VARCHAR" />
		<result column="picture" property="picture" jdbcType="VARCHAR" />
		<result column="state" property="state" jdbcType="VARCHAR" />
		<result column="userid" property="userid" jdbcType="VARCHAR" />
		<result column="uid" property="uid" jdbcType="VARCHAR" />


		<result column="invqty" property="invqty" jdbcType="INTEGER" />
	</resultMap>
	<sql id="cons">
		con.conid,
		con.conname,
		con.starttime,
		con.endtime,
		con.picture,
		con.state,
		con.userid,
		con.uid,
		username
	</sql>
	<sql id="con">
		conid,
		conname,
		starttime,
		endtime,
		picture,
		state,
		userid,
		uid
	</sql>
	<!-- 添加新合同 -->
	<insert id="addContract" parameterType="com.yonyou.cons.entity.Contract"> 
	INSERT INTO contract
		(conid,conname,company,starttime,endtime,picture,state,userid,uid)
		VALUES(#{conid},#{conname},#{company},#{startDate},#{endDate},#{picture},#{state},#{userid},#{uid})
	</insert>

	<!-- 根据相关id查找合同 -->
	<select id="findContracsByUid" parameterType="String" resultMap="Contract">
		SELECT
		<include refid="cons" />
		FROM
		contract con
		inner join user
		on user.userid=con.uid
		where
		con.uid=#{userid} or con.userid=#{userid} ORDER BY endtime
		DESC
	</select>

	<!-- 根据关键字查询合同 -->
	<select id="findContractByWord" parameterType="String"
		resultMap="Contract">
		SELECT <include refid="cons"/> 
		FROM(SELECT <include refid="con"/> FROM contract WHERE uid=#{userid} OR userid=#{userid}) con 
		INNER JOIN USER 
		ON user.userid=con.uid  
		WHERE con.conname LIKE '%${part}%'
		ORDER BY endtime
		DESC
	</select>
	<!-- 根据合同id更新合同 -->
	<update id="updateCon" parameterType="String">
		update contract
		set state=1
		where conid=#{conid}
	</update>
</mapper>